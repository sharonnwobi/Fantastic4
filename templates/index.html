{% extends "base.html" %}

{% block content %}

<span id="stocks-data" style="display: none;">{{ stocks | tojson }}</span>
<span id="history-data" style="display: none;">{{ history | tojson }}</span>
<span id="portfolio-history-data" style="display:none;">{{ portfolioHistory | tojson }}</span>
<span id="portfolio-labels" style="display:none;">{{ portfolioLabels | tojson }}</span>


<div class="charts">
  <canvas id="pieChart" width="800" height="400"></canvas>
  <div class="linecharts">

    <select id="timeRange">
      <option value="All" selected>All</option>
      <option value="5">5 minutes</option>
      <option value="60">60 minutes</option>
      <option value="180">3 Hours</option>
      <option value="360">6 Hours</option>
      <option value="720">12 Hours</option>
      <option value="1440">24 Hours</option>
    </select>

    <canvas id="portfolioChart" width="800" height="600"></canvas>
  </div>
</div>
<table>
  <tr>
    <th>Symbol</th>
    <th>Price</th>
    <th>Quantity</th>
  </tr>
  <tr>
    {% for stock in stocks %}
    <td>{{ stock[1] }}</td>
    <td>${{ '%0.2f' | format(stock[2]) }}</td>
    <td>{{ stock[3]| int }}</td>
  </tr>
  {% endfor %}
  <tr>
    <td><strong>Total</strong></td>
    <td><strong>${{ '%0.2f' | format(total_price) }}</strong></td>
    <td><strong>{{ '%d' | format(total_quantity) }}</strong></td>
  </tr>
</table>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>


  document.addEventListener("DOMContentLoaded", function () {
    const stocks = JSON.parse(document.getElementById("stocks-data").textContent);
    const history = JSON.parse(document.getElementById("history-data").textContent);

    const portfolioHistory = JSON.parse(document.getElementById("portfolio-history-data").textContent);
    const labelsUtc = JSON.parse(document.getElementById("portfolio-labels").textContent);

    const datesLocal = labelsUtc.map(s => {
      const iso = s.replace(' ', 'T') + ':00Z';
      return new Date(iso);
    });

    const fmt = new Intl.DateTimeFormat(navigator.language, {
      hour12: false, year: 'numeric', month: '2-digit', day: '2-digit', hour: '2-digit', minute: '2-digit'
    });

    const labelsLocal = datesLocal.map(d => fmt.format(d));

    const ctx = document.getElementById('portfolioChart').getContext('2d');

    let chart = new Chart(ctx, {
      type: 'line',
      data: {
        labels: labelsLocal,
        datasets: [{
          label: 'Portfolio Value Over Time',
          data: portfolioHistory,
          fill: false,
          borderColor: 'rgb(75, 192, 192)',
          tension: 0.1
        }]
      },
      options: {
        plugins: {
          legend: {
            labels: {
              color: "#FFFFFF"
            }
          }, 
        },
        responsive: true,
        scales: {
          x: { ticks: { autoSkip: true, maxTicksLimit: 7, color:"#FFFFFF", callback: function(value, index, ticks) {
            let date = new Date(this.getLabelForValue(value));
            return date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
          } } },
          y: { beginAtZero: false, ticks:{color:"#FFFFFF"},title: { display: true, text: 'USD ($)', color:"#FFFFFF" } }
        }
      }
    });



    const pieData = {
      labels: stocks.map(stock => stock[1]),
      datasets: [{
        label: 'Portfolio Distribution',
        data: stocks.map(stock => parseFloat(stock[2])),
        backgroundColor: [
          'rgba(255, 99, 132, 0.8)',
          'rgba(54, 162, 235, 0.8)',
          'rgba(255, 206, 86, 0.8)',
          'rgba(75, 192, 192, 0.8)',
          'rgba(153, 102, 255, 0.8)',
          'rgba(255, 159, 64, 0.8)',
          'rgba(201, 203, 207, 0.8)',
          'rgba(255, 99, 132, 0.8)',
          'rgba(54, 162, 235, 0.8)',
          'rgba(255, 206, 86, 0.8)'
        ],
        borderColor: [
          'rgba(255, 99, 132, 1)',
          'rgba(54, 162, 235, 1)',
          'rgba(255, 206, 86, 1)',
          'rgba(75, 192, 192, 1)',
          'rgba(153, 102, 255, 1)'
        ],
        borderWidth: 1
      }]
    };
    const pieCtx = document.getElementById('pieChart').getContext('2d');
    new Chart(pieCtx, {
      type: 'pie',
      data: pieData,
      options: {
        responsive: true,
        plugins: {
          legend: {
            position: 'top',
            labels:{
              color: '#FFFFFF'
            }
          },
          title: {
            display: true,
            text: 'Portfolio Distribution by Stock',
            font: {
              size: 16,
              family: 'Arial',
              weight: 'normal',
            },
            color: '#FFFFFF'
          }
        }
      }
    });
    function filteredData(range) {

      if (range === "All") {
        return { labels: labelsLocal, data: portfolioHistory }
      }
      const now = new Date()
      range *= 60000
      range += 300000
      const filtered = datesLocal.map((data, i) => ({ date: data, label: labelsLocal[i], value: portfolioHistory[i] }))
        .filter(datapoint => now - datapoint.date <= parseInt(range))
      return {
        labels: filtered.map(data => data.label),
        data: filtered.map(data => data.value)
      }

    }
    document.getElementById("timeRange").addEventListener("change", function () {
      const { labels, data } = filteredData(this.value)
      chart.data.labels = labels
      chart.data.datasets[0].data = data
      chart.update()

    });
  });
</script>

{% endblock %}