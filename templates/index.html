{% extends "base.html" %}

{% block content %}
<h2>Stock Portfolio</h2>
<p>My stocks</p>
<table>
  <tr>
    <th>Symbol</th>
    <th>total_price</th>
    <th>total_quantity</th>
  </tr>
  <tr>
    {% for stock in stocks %}
      <td>{{ stock[1] }}</td>
      <td>{{ stock[2] }}</td>
      <td>{{ stock[3] }}</td>
    </tr>
    {% endfor %}
  </tr>
</table>
<span id="stocks-data" style="display: none;">{{ stocks | tojson }}</span>
<span id="history-data" style="display: none;">{{ history | tojson }}</span>

<canvas id="portfolioChart" width="800" height="400"></canvas>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
document.addEventListener("DOMContentLoaded", function () {
  const stocks = JSON.parse(document.getElementById("stocks-data").textContent);
  const history = JSON.parse(document.getElementById("history-data").textContent);

  const portfolioHistory = [];
  const labels = history[0].history.timestamps;
  
  for (let i = 0; i < labels.length; i++) {
    let total = 0;
    
    for (let h = 0; h < history.length; h++) {
      const symbol = history[h].symbol;
      const price = history[h].history.prices[i];
      
      const matchingStock = stocks.find(s => s[1] === symbol);
      if (!matchingStock) continue;

      const quantity = parseFloat(matchingStock[3]);
      total += price * quantity;
    }

    portfolioHistory.push(total.toFixed(2));
  }

  const ctx = document.getElementById('portfolioChart').getContext('2d');
  new Chart(ctx, {
    type: 'line',
    data: {
      labels: labels,
      datasets: [{
        label: 'Portfolio Value Over Time',
        data: portfolioHistory,
        fill: false,
        borderColor: 'rgb(75, 192, 192)',
        tension: 0.1
      }]
    },
    options: {
      responsive: true,
      scales: {
        x: {
          ticks: {
            autoSkip: true,
            maxTicksLimit: 15
          }
        },
        y: {
          beginAtZero: false,
          title: {
            display: true,
            text: 'USD ($)'
          }
        }
      }
    }
  });
});
</script>

{% endblock %}

{% block sidebar %}
    {% include "sidebar.html" %}
{% endblock %}
